"""
This script reads the docking_benchmark_dataset.csv file generated by
01_generate_benchmark_dataset.py and adds information about the structure quality, i.e. the iridium
category.
"""
from pathlib import Path

from openeye import oechem
import pandas as pd


def get_iridium_category(pdb_id, chain_id, expo_id):
    """Get the iridum category of the given structure."""
    from kinoml.modeling.OEModeling import read_molecules, read_electron_density, prepare_complex
    from kinoml.databases.pdb import download_pdb_structure
    from kinoml.utils import LocalFileStorage, FileDownloader

    structure_path = download_pdb_structure(pdb_id)
    if pdb_id:
        structure = read_molecules(structure_path)[0]
    else:
        raise ValueError(f"Could not download PDB entry {pdb_id}!")

    electron_density_path = LocalFileStorage.rcsb_electron_density_mtz(pdb_id)
    if not electron_density_path.is_file():
        if not FileDownloader.rcsb_electron_density_mtz(pdb_id):
            return "NA"
    electron_density = read_electron_density(electron_density_path)

    design_unit = prepare_complex(
        structure, electron_density=electron_density, chain_id=chain_id, ligand_name=expo_id
    )
    iridium_data = design_unit.GetStructureQuality().GetIridiumData()

    return oechem.OEGetIridiumCategoryName(iridium_data.GetCategory())

path_log = Path("../data/iridium_categories.log")
if path_log.is_file():
    path_log.unlink()

docking_benchmark_dataset = pd.read_csv("../data/docking_benchmark_dataset.csv", index_col=0)

iridium_categories = []
for i, (index, structure) in enumerate(docking_benchmark_dataset.iterrows()):
    print(
        f"{i + 1}/{len(docking_benchmark_dataset)}",
        structure["structure.pdb_id"],
        structure["structure.chain"],
        structure["ligand.expo_id"]
    )
    iridium_categories.append(get_iridium_category(
        structure["structure.pdb_id"], structure["structure.chain"], structure["ligand.expo_id"]
    ))

docking_benchmark_dataset.loc[:, "iridium_category"] = iridium_categories

with open(path_log, "w") as log_file:
    log_file.write(f"Iridium category distribution:")
    log_file.write(f"\nHT: {len([x for x in iridium_categories if x == 'HT'])}")
    log_file.write(f"\nMT: {len([x for x in iridium_categories if x == 'MT'])}")
    log_file.write(f"\nNT: {len([x for x in iridium_categories if x == 'NT'])}")
    log_file.write(f"\nNA: {len([x for x in iridium_categories if x == 'NA'])}")

docking_benchmark_dataset.to_csv("../data/docking_benchmark_dataset_edit.csv")
print("Finished!")
